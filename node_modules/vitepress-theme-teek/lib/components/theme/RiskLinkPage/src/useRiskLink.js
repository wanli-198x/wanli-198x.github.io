'use strict';

var Vue = require('vue');
var index$1 = require('../../../../helper/dist/index.js');
var useEventListener = require('../../../../composables/useEventListener.js');
require('vitepress');
var useScopeDispose = require('../../../../composables/useScopeDispose.js');
require('vitepress-theme-teek/theme-chalk/tk-copy-banner.css');
require('../../../../composables/useZIndex.js');
var index = require('../../ConfigProvider/index.js');

const useRiskLink = (options = {}) => {
  const riskLinks = /* @__PURE__ */ new Set();
  const cleanups = [];
  const { riskLinkPath } = index.usePagePath();
  const { whitelist = [], blacklist = [] } = options;
  const isSome = (arr, name) => {
    return arr.some(
      (item) => item === name || index$1.isString(item) && name.startsWith(item) || item instanceof RegExp && item.test(name)
    );
  };
  const isRiskLink = (url, currentDomain) => {
    const link = new URL(url, window.location.origin);
    return link.hostname !== currentDomain && !isSome(whitelist, url);
  };
  const start = async () => {
    await Vue.nextTick();
    if (!index$1.isClient) return;
    document.querySelectorAll("a").forEach((link) => {
      const href = link.getAttribute("href");
      const currentDomain = window.location.hostname;
      if (!href || riskLinks.has(link)) return;
      if (blacklist.length && !isSome(blacklist, href)) return;
      if (!isRiskLink(href, currentDomain)) return;
      riskLinks.add(link);
      const stop2 = useEventListener.useEventListener(link, "click", (e) => {
        e.preventDefault();
        const encodedUrl = encodeURIComponent(href);
        window.open(`${riskLinkPath.value}?target=${encodedUrl}`);
      });
      cleanups.push(stop2);
    });
  };
  const stop = () => {
    cleanups.forEach((fn) => fn());
    cleanups.length = 0;
    riskLinks.clear();
  };
  const restart = () => {
    stop();
    start();
  };
  useScopeDispose.useScopeDispose(stop);
  return { start, stop, restart };
};

exports.useRiskLink = useRiskLink;
