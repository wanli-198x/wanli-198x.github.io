import { reactive, watch } from 'vue';
import { useData } from 'vitepress';
import { useEventListener } from './useEventListener.mjs';
import { isClient } from '../helper/dist/index.mjs';
import { useMounted } from './useMounted.mjs';

const useAnchorScroll = () => {
  const { theme } = useData();
  const currentAnchor = reactive({ id: "", top: -1 });
  const calculateCurrentAnchor = () => {
    const anchors = document.querySelectorAll(".content-container .main :is(h1, h2, h3, h4, h5, h6)");
    for (let i = 0; i < anchors.length; i++) {
      const anchor = anchors[i];
      const computedStyle = window.getComputedStyle(anchor);
      if (computedStyle.display === "none") break;
      const rect = anchor.getBoundingClientRect();
      if (rect.top <= 150 && anchor.id !== currentAnchor.id) {
        currentAnchor.id = anchor.id;
        currentAnchor.top = rect.top;
      }
    }
  };
  useMounted(() => {
    useEventListener(window, "scroll", calculateCurrentAnchor);
  });
  const startWatch = () => {
    if (theme.value.anchorScroll === false) return;
    watch(
      () => currentAnchor.id,
      (val) => {
        if (!isClient || !val) return;
        window.history.replaceState(history.state || null, "", `#${val}`);
      }
    );
  };
  return { startWatch };
};

export { useAnchorScroll };
