'use strict';

var Vue = require('vue');
var vitepress = require('vitepress');
var index = require('../helper/dist/index.js');

const vpBrand1 = "--vp-c-brand-1";
const vpBrand2 = "--vp-c-brand-2";
const vpBrand3 = "--vp-c-brand-3";
const vpBrandSoft = "--vp-c-brand-soft";
const vpBg = "--vp-c-bg";
const vpBgAlt = "--vp-c-bg-alt";
const vpBgSoft = "--vp-c-bg-soft";
const vpBgElv = "--vp-c-bg-elv";
const vpText1 = "--vp-c-text-1";
const vpText2 = "--vp-c-text-2";
const vpText3 = "--vp-c-text-3";
const tkBgColorElm = "--tk-bg-color-elm";
const tkBgColorMute = "--tk-bg-color-mute";
const varNameList = {
  vpBrand1,
  vpBrand2,
  vpBrand3,
  vpBrandSoft,
  vpBg,
  vpBgAlt,
  vpBgSoft,
  vpBgElv,
  vpText1,
  vpText2,
  vpText3,
  tkBgColorElm,
  tkBgColorMute
};
const useThemeColor = (color, ignoreList) => {
  const isSpread = Vue.ref(false);
  const { isDark } = vitepress.useData();
  const setStyleVar = (key, value) => {
    if (!index.isClient) return;
    document.documentElement.style.setProperty(key, value);
  };
  const removeStyleVar = (key) => {
    if (!index.isClient) return;
    document.documentElement.style.removeProperty(key);
  };
  const colorComputed = Vue.computed(() => Vue.toValue(color));
  const clear = () => {
    Object.values(varNameList).forEach((key) => {
      removeStyleVar(key);
    });
  };
  const switchLight = () => {
    if (!index.isClient) return;
    const primary = colorComputed.value;
    if (!primary) return;
    const lightVarDefaultMap = {
      [vpBrand1]: primary,
      [vpBrand2]: index.getLightColor(primary, 0.1),
      [vpBrand3]: index.getLightColor(primary, 0.2),
      [vpBrandSoft]: index.getLightColor(primary, 0.85)
    };
    const lightVarSpreadMap = {
      [vpBg]: index.getLightColor(primary, 0.96),
      [vpBgAlt]: index.getLightColor(primary, 0.93),
      [vpBgElv]: index.getLightColor(primary, 0.945),
      [vpBgSoft]: index.getLightColor(primary, 0.93),
      [vpText1]: index.getDarkColor(primary, 0.6),
      [vpText2]: index.getDarkColor(primary, 0.7),
      [vpText3]: index.getLightColor(primary, 0.6),
      [tkBgColorElm]: index.getLightColor(primary, 0.945),
      [tkBgColorMute]: index.getLightColor(primary, 0.91)
    };
    const ignoreListConst = index.isFunction(ignoreList) ? ignoreList() : ignoreList || [];
    Object.keys(lightVarDefaultMap).forEach((key) => {
      if (ignoreListConst?.includes(key)) return;
      setStyleVar(key, lightVarDefaultMap[key]);
    });
    if (isSpread.value) {
      Object.keys(lightVarSpreadMap).forEach((key) => {
        if (ignoreListConst?.includes(key)) return;
        setStyleVar(key, lightVarSpreadMap[key]);
      });
    }
  };
  const switchDark = () => {
    if (!index.isClient) return;
    const primary = colorComputed.value;
    if (!primary) return;
    const darkVarDefaultMap = {
      [vpBrand1]: primary,
      [vpBrand2]: index.getDarkColor(primary, 0.1),
      [vpBrand3]: index.getDarkColor(primary, 0.2),
      [vpBrandSoft]: index.getDarkColor(primary, 0.85)
    };
    const darkVarSpreadMap = {
      [vpBg]: index.getDarkColor(primary, 0.92),
      [vpBgAlt]: index.getDarkColor(primary, 0.94),
      [vpBgElv]: index.getDarkColor(primary, 0.92),
      [vpBgSoft]: index.getDarkColor(primary, 0.94),
      [vpText1]: index.getLightColor(primary, 0.9),
      [tkBgColorElm]: index.getDarkColor(primary, 0.92),
      [tkBgColorMute]: index.getDarkColor(primary, 0.91)
    };
    const ignoreListConst = index.isFunction(ignoreList) ? ignoreList() : ignoreList || [];
    Object.keys(darkVarDefaultMap).forEach((key) => {
      if (ignoreListConst?.includes(key)) return;
      setStyleVar(key, darkVarDefaultMap[key]);
    });
    if (isSpread.value) {
      Object.keys(darkVarSpreadMap).forEach((key) => {
        if (ignoreListConst?.includes(key)) return;
        setStyleVar(key, darkVarSpreadMap[key]);
      });
    }
  };
  const isStop = Vue.shallowRef(false);
  let stopWatch = null;
  const start = () => {
    if (!isStop.value || !!stopWatch) return;
    isStop.value = false;
    update();
    stopWatch = Vue.watch(isDark, update, { flush: "post" });
  };
  const update = () => {
    if (isStop.value) return;
    clear();
    if (isDark.value) switchDark();
    else switchLight();
  };
  const stop = () => {
    stopWatch?.();
    stopWatch = null;
    isStop.value = true;
    clear();
  };
  start();
  Vue.watch(colorComputed, update);
  Vue.watch(isSpread, () => {
    stop();
    start();
  });
  return {
    isSpread: Vue.readonly(isSpread),
    start,
    stop,
    update,
    clear,
    updateSpread: (value) => isSpread.value = value
  };
};

exports.useThemeColor = useThemeColor;
exports.varNameList = varNameList;
