'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

const node_fs = require('node:fs');
const node_path = require('node:path');
const matter = require('gray-matter');
const node_os = require('node:os');

function _interopDefaultCompat (e) { return e && typeof e === 'object' && 'default' in e ? e.default : e; }

const matter__default = /*#__PURE__*/_interopDefaultCompat(matter);

function VitePluginVitePressMdH1(option = {}) {
  return {
    name: "vite-plugin-vitepress-md-h1",
    load: (id) => {
      if (!id.endsWith(".md") || !node_fs.existsSync(id)) return;
      const { ignoreList = [], beforeInject } = option;
      if (isSome(ignoreList, id)) return;
      const content = node_fs.readFileSync(id, "utf-8");
      const { data: frontmatter = {}, content: mdContent } = matter__default(content, {});
      if (frontmatter.autoTitle === void 0 && ![void 0, "doc"].includes(frontmatter.layout)) return;
      if (frontmatter.autoTitle === false) return;
      if (mdContent.trimStart().split(/\r?\n/)[0].startsWith("# ")) return;
      let title = frontmatter.title || getMdFileTitle(node_path.basename(id)) || "";
      if (beforeInject && typeof beforeInject === "function") {
        const result = beforeInject(frontmatter, id, title);
        if (result === false) return;
        if (typeof result === "string") title = result;
      }
      const newTwoLine = node_os.EOL + node_os.EOL;
      if (content.trimStart().startsWith("---")) {
        return content.replace(/^(\s*---[\s\S]*?---)/, `$1${newTwoLine}# ${title}${newTwoLine}`);
      }
      return `# ${title}${newTwoLine}${content}`;
    }
  };
}
const getMdFileTitle = (filename) => {
  let title = "";
  const fileNameArr = filename.split(".");
  if (fileNameArr.length === 2) title = fileNameArr[0];
  else {
    const firstDotIndex = filename.indexOf(".");
    const lastDotIndex = filename.lastIndexOf(".");
    title = filename.substring(firstDotIndex + 1, lastDotIndex);
  }
  return title;
};
const isSome = (arr, name) => {
  return arr.some(
    (item) => typeof item === "string" && name.includes(item) || item instanceof RegExp && item.test(name)
  );
};

exports.default = VitePluginVitePressMdH1;
exports.getMdFileTitle = getMdFileTitle;
