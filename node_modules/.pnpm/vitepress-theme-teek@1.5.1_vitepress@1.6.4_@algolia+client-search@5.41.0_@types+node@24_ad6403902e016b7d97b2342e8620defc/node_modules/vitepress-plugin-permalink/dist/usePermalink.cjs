'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

const vitepress = require('vitepress');
const vue = require('vue');

function usePermalink(executeBeforeMountFn = true) {
  const fakeHost = "http://a.com";
  const router = vitepress.useRouter();
  const { site, theme, localeIndex } = vitepress.useData();
  const { base, cleanUrls } = site.value;
  const { permalinks = {} } = theme.value;
  const permalinkKeys = Object.keys(permalinks);
  const replaceUrlWhenPermalinkExist = async (href) => {
    if (!permalinkKeys.length) return;
    const { pathname, search, hash } = new URL(href, fakeHost);
    const decodePath = decodeURIComponent(pathname.slice(base.length));
    const permalink = permalinks.map[decodePath.replace(/\.html/, "")];
    if (permalink === "/" + decodePath) return;
    if (permalink) {
      return vue.nextTick(async () => {
        const to = base.replace(/\/$/, "") + permalink + search + hash;
        history.replaceState(history.state || null, "", to);
        await router.onAfterUrlLoad?.(to);
      });
    }
    const filePath = teyGetFilePathByPermalink(pathname);
    if (filePath) {
      const targetUrl = base + filePath + search + hash;
      history.replaceState(history.state || null, "", targetUrl);
      await router.go(targetUrl);
    } else await router.onAfterUrlLoad?.(href);
  };
  if (executeBeforeMountFn) {
    vue.onBeforeMount(async () => {
      if (!router.state.permalinkPlugin) router.state = { ...router.state, permalinkPlugin: true };
      await replaceUrlWhenPermalinkExist(window.location.href);
    });
  }
  const teyGetFilePathByPermalink = (pathname) => {
    const decodePath = "/" + decodeURIComponent(pathname.slice(base.length)).replace(/\/$/, "").replace(/\.html/, "");
    const li = localeIndex.value;
    const maybeIsPermalink = cleanUrls ? decodePath : decodePath + ".html";
    let filePath = "";
    if (li !== "root" && !maybeIsPermalink.startsWith(`/${li}/`)) {
      filePath = permalinks.inv[`/${li}${maybeIsPermalink}`];
    } else filePath = permalinks.inv[maybeIsPermalink];
    if (`/${filePath}` === decodePath) return "";
    return filePath;
  };
  const startWatch = () => {
    if (!permalinkKeys.length) return;
    const state = router.state || {};
    if (state.permalinkPlugin) return;
    const selfOnBeforeRouteChange = router.onBeforeRouteChange;
    router.onBeforeRouteChange = async (href) => {
      const selfResult = await selfOnBeforeRouteChange?.(href);
      if (selfResult === false) return false;
      if (href === base) return;
      const { pathname, search, hash } = new URL(href, fakeHost);
      const filePath = teyGetFilePathByPermalink(pathname);
      if (filePath) {
        const targetUrl = base + filePath + search + hash;
        await router.go(targetUrl);
        return false;
      }
    };
    const selfOnAfterRouteChange = router.onAfterRouteChange;
    router.onAfterRouteChange = async (href) => {
      await replaceUrlWhenPermalinkExist(href);
      await selfOnAfterRouteChange?.(href);
    };
    router.state = { ...router.state, permalinkPlugin: true };
  };
  return { startWatch, teyGetFilePathByPermalink };
}

exports.default = usePermalink;
