'use strict';

var vitepress = require('vitepress');

const useVpRouter = () => {
  const router = vitepress.useRouter();
  const bindBeforeRouteChange = (stateFlag, bindFn, bindPosition = "after") => {
    const { state = {}, onBeforeRouteChange } = router;
    if (state[stateFlag]) return;
    const beforeFn = bindPosition === "before" ? bindFn : onBeforeRouteChange;
    const afterFn = bindPosition === "after" ? bindFn : onBeforeRouteChange;
    router.onBeforeRouteChange = async (href) => {
      const res = await beforeFn?.(href);
      if (res === false) return false;
      return await afterFn?.(href);
    };
    router.state = { ...state, [stateFlag]: true };
  };
  const bindBeforePageLoad = (stateFlag, bindFn, bindPosition = "after") => {
    const { state = {}, onBeforePageLoad } = router;
    if (state[stateFlag]) return;
    const beforeFn = bindPosition === "before" ? bindFn : onBeforePageLoad;
    const afterFn = bindPosition === "after" ? bindFn : onBeforePageLoad;
    router.onBeforePageLoad = async (href) => {
      const res = await beforeFn?.(href);
      if (res === false) return false;
      return await afterFn?.(href);
    };
    router.state = { ...state, [stateFlag]: true };
  };
  const bindAfterPageLoad = (stateFlag, bindFn, bindPosition = "after") => {
    const { state = {}, onAfterPageLoad } = router;
    if (state[stateFlag]) return;
    const beforeFn = bindPosition === "before" ? bindFn : onAfterPageLoad;
    const afterFn = bindPosition === "after" ? bindFn : onAfterPageLoad;
    router.onAfterPageLoad = async (href) => {
      await beforeFn?.(href);
      await afterFn?.(href);
    };
    router.state = { ...state, [stateFlag]: true };
  };
  const bindAfterRouteChange = (stateFlag, bindFn, bindPosition = "after") => {
    const { state = {}, onAfterRouteChange } = router;
    if (state[stateFlag]) return;
    const beforeFn = bindPosition === "before" ? bindFn : onAfterRouteChange;
    const afterFn = bindPosition === "after" ? bindFn : onAfterRouteChange;
    router.onAfterRouteChange = async (href) => {
      await beforeFn?.(href);
      await afterFn?.(href);
    };
    router.state = { ...state, [stateFlag]: true };
  };
  const bindRouterFn = (stateFlag, bindFn) => {
    const { state = {} } = router;
    if (state[stateFlag]) return;
    bindFn(router);
    router.state = { ...state, [stateFlag]: true };
  };
  return {
    router,
    route: router.route,
    bindBeforeRouteChange,
    bindBeforePageLoad,
    bindAfterPageLoad,
    bindAfterRouteChange,
    bindRouterFn
  };
};

exports.useVpRouter = useVpRouter;
